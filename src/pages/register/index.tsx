import { Button, message, Result } from 'antd'
import FormRender, { useForm } from 'form-render'
import React, { Fragment, useEffect, useLayoutEffect, useState } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { getCompetitionInfo, getCompetitionSignInfo, getTeamInfo, signUp } from '../../api/user'
import TopBar from '../../components/TopBar'
import './index.scss'

function Register() {
  const form = useForm()
  const { id } = useParams()
  const [messageSent, setMessageSent] = useState(false)
  const [loading, setLoading] = useState(false)
  const [messageStatus, setMessageStatus] = useState('null')
  const [errCode, setErrCode] = useState(0)
  const [errMsg, setErrMsg] = useState('')
  const [competitionInfo, setCompetitionInfo] = useState({
    minParti: 1,
    maxParti: 1,
  })
  const navigate = useNavigate()
  const [curParti, setCurParti] = useState(1)
  const [teamInfo, setTeamInfo] = useState({})
  const [formSchema, setFormSchema] = useState<any>({
    type: 'object',
    labelWidth: 151,
    displayType: 'column',
    properties: {
      input_teamName: {
        title: 'Èòü‰ºçÂêçÁß∞',
        type: 'string',
        displayType: 'column',
        required: true,
        labelWidth: 0,
        props: {},
      },
      select_numOfParti: {
        title: 'ÂèÇËµõ‰∫∫Êï∞',
        type: 'number',
        widget: 'slider',
        displayType: 'column',
        description: 'ÊúÄÂ∞ë‰∫∫Êï∞ ' + competitionInfo.minParti + ' ÔºõÊúÄÂ§ö‰∫∫Êï∞ ' + competitionInfo.maxParti,
        required: true,
        placeholder: '',
        min: competitionInfo.minParti,
        max: competitionInfo.maxParti,
        default: curParti,
      },
      leader: {
        title: 'ÈòüÈïø‰ø°ÊÅØ',
        type: 'object',
        displayType: 'column',
        description: 'ÈòüÈïø‰ø°ÊÅØÂ∑≤Ëá™Âä®Â°´ÂÜô',
        properties: {
          name: {
            title: 'ÂßìÂêç',
            type: 'string',
            readOnly: true,
            props: {},
          },
          code: {
            title: 'Â≠¶Âè∑',
            type: 'string',
            readOnly: true,
            props: {},
          },
        },
      },
    },
  })
  const storeTeamInfo = () => {
    setLoading(true)
    message.loading({
      content: 'ü§îÔ∏è Ê≠£Âú®Ëé∑ÂèñÂ∑≤‰øùÂ≠ò‰ø°ÊÅØÔºåËØ∑Á®çÂÄô',
      key: 'loading',
      duration: 50,
    })
    getTeamInfo(Number(id)).then((res) => {
      // console.log(res)
      form.setValueByPath('leader', {
        name: localStorage.getItem('approval-system-name'),
        code: localStorage.getItem('approval-system-code'),
      })
      if (res.data.errCode !== 2003) {
        setTeamInfo({
          teamName: res.data.data.teamName,
          teamMember: res.data.data.teamMember,
        })
        form.setValueByPath('select_numOfParti', res.data.data.teamMember.length)
        setCurParti(res.data.data.teamMember.length)
        const newEle = generateForm(res.data.data.teamMember.length)
        newEle.forEach((element) => {
          setFormSchema((prev: any) => {
            return { ...prev, properties: { ...prev.properties, ...element } }
          })
        })
        form.setValueByPath('input_teamName', res.data.data.teamName)
        for (let i = 1; i <= res.data.data.teamMember.length - 1; i++) {
          const formName = 'parti' + i
          form.setValueByPath(formName, {
            name: res.data.data.teamMember[i].name,
            code: res.data.data.teamMember[i].code,
          })
        }
        setLoading(false)
        message.success({
          content: 'üò∏Ô∏è ‰ø°ÊÅØÂä†ËΩΩÊàêÂäü',
          key: 'loading',
        })
      } else if (res.data.errMsg === 'ÊÇ®ËøòÊú™Êä•ÂêçËØ•ÊØîËµõ') {
        setLoading(false)
        message.info({
          content: 'üí°Ô∏è ËØ∑Â°´ÂÜôÊØîËµõ‰ø°ÊÅØ',
          key: 'loading',
        })
      } else {
        setLoading(false)
        message.error({
          content: 'üôÄÔ∏è ‰ø°ÊÅØÂä†ËΩΩÈîôËØØÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò',
          key: 'loading',
        })
      }
    })
  }
  useEffect(() => {
    getCompetitionSignInfo(Number(id)).then((res) => {
      console.log(res)
      setCompetitionInfo({
        maxParti: res.data.data.maxTeamMembers,
        minParti: res.data.data.minTeamMembers,
      })
      setFormSchema({
        type: 'object',
        labelWidth: 151,
        displayType: 'column',
        properties: {
          input_teamName: {
            title: 'Èòü‰ºçÂêçÁß∞',
            type: 'string',
            displayType: 'column',
            required: true,
            labelWidth: 0,
            props: {},
          },
          select_numOfParti: {
            title: 'ÂèÇËµõ‰∫∫Êï∞',
            type: 'number',
            widget: 'slider',
            displayType: 'column',
            description: 'ÊúÄÂ∞ë‰∫∫Êï∞ ' + res.data.data.minTeamMembers + ' ÔºõÊúÄÂ§ö‰∫∫Êï∞ ' + res.data.data.maxTeamMembers,
            required: true,
            placeholder: '',
            min: res.data.data.minTeamMembers,
            max: res.data.data.maxTeamMembers,
            default: curParti,
          },
          leader: {
            title: 'ÈòüÈïø‰ø°ÊÅØ',
            type: 'object',
            displayType: 'column',
            description: 'ÈòüÈïø‰ø°ÊÅØÂ∑≤Ëá™Âä®Â°´ÂÜô',
            properties: {
              name: {
                title: 'ÂßìÂêç',
                type: 'string',
                readOnly: true,
                props: {},
              },
              code: {
                title: 'Â≠¶Âè∑',
                type: 'string',
                readOnly: true,
                props: {},
              },
            },
          },
        },
      })
    })
    storeTeamInfo()
  }, [])
  // console.log(teamInfo)
  const generateForm = (number: number) => {
    const participants: any[] = []
    for (let i = 1; i <= number - 1; i++) {
      const formName = 'parti' + i
      const inputName = 'name'
      const inputName2 = 'code'
      participants.push({
        [formName]: {
          title: 'ÈòüÂëò' + i + '‰ø°ÊÅØ',
          type: 'object',
          displayType: 'column',
          properties: {
            [inputName]: {
              title: 'ÂßìÂêç',
              type: 'string',
              required: true,
              props: {},
            },
            [inputName2]: {
              title: 'Â≠¶Âè∑',
              type: 'string',
              required: true,
              props: {},
            },
          },
        },
      })
    }
    return participants
  }

  /**
   * Ë°®ÂçïÊèê‰∫§ÁöÑÂèçÂ∫î
   * @param formData Ë°®ÂçïÊï∞ÊçÆ
   * @param errors ÈîôËØØ
   */
  const onFinish = (formData: any, errors: any) => {
    console.log('formData:', formData, 'errors', errors)
    if (errors.length === 0) {
      setLoading(true)
      message.loading({
        content: 'ü§îÔ∏è ‰ø°ÊÅØÊèê‰∫§‰∏≠',
        key: 'loading',
        duration: 50,
      })
      const teamName = formData.input_teamName
      const teamMember = []
      // teamMember.push(formData.leader)
      for (let i = 1; i <= Number(formData.select_numOfParti) - 1; i++) {
        const formName = 'parti' + i
        teamMember.push(formData[formName])
      }
      console.log('teamName', teamName, 'teamMember', teamMember)
      signUp(Number(id), teamName, teamMember).then((res) => {
        console.log(res)
        setMessageSent(true)
        if (res.data.success === true) {
          setMessageStatus('success')
          message.success({
            content: 'üò∏Ô∏è ‰ø°ÊÅØÊèê‰∫§ÊàêÂäü',
            key: 'loading',
          })
        } else {
          setMessageStatus('error')
          setErrCode(res.data.errCode)
          setErrMsg(res.data.errMsg)
          message.error({
            content: 'üôÄÔ∏è ‰ø°ÊÅØÂ•ΩÂÉèÊúâÁÇπÈóÆÈ¢òÂì¶ÔºåÊ£ÄÊü•‰∏ãÂêß',
            key: 'loading',
            duration: 3,
          })
        }
      })
    }
  }
  /**
   * ÈÄöËøáÁõëÂê¨Ë°®ÂçïÁöÑÊîπÂèòÊù•ÂÆûÁé∞Âä®ÊÄÅË°®Âçï
   * @param values ÊîπÂèòÁöÑÂÄº
   */
  const valueChangeAction = (values: any) => {
    console.log(values)
    if (values.select_numOfParti !== undefined) {
      setFormSchema({
        type: 'object',
        labelWidth: 151,
        displayType: 'column',
        properties: {
          input_teamName: {
            title: 'Èòü‰ºçÂêçÁß∞',
            type: 'string',
            displayType: 'column',
            required: true,
            labelWidth: 0,
            props: {},
          },
          select_numOfParti: {
            title: 'ÂèÇËµõ‰∫∫Êï∞',
            type: 'number',
            widget: 'slider',
            displayType: 'column',
            description: 'ÊúÄÂ∞ë‰∫∫Êï∞ ' + competitionInfo.minParti + ' ÔºõÊúÄÂ§ö‰∫∫Êï∞ ' + competitionInfo.maxParti,
            required: true,
            placeholder: '',
            min: competitionInfo.minParti,
            max: competitionInfo.maxParti,
            default: curParti,
          },
          leader: {
            title: 'ÈòüÈïø‰ø°ÊÅØ',
            type: 'object',
            displayType: 'column',
            description: 'ÈòüÈïø‰ø°ÊÅØÂ∑≤Ëá™Âä®Â°´ÂÜô',
            properties: {
              name: {
                title: 'ÂßìÂêç',
                type: 'string',
                readOnly: true,
                props: {},
              },
              code: {
                title: 'Â≠¶Âè∑',
                type: 'string',
                readOnly: true,
                props: {},
              },
            },
          },
        },
      })
      const number = Number(values.select_numOfParti)
      setCurParti(number)
      console.log(number)
      const newEle = generateForm(number)
      newEle.forEach((element) => {
        setFormSchema((prev: any) => {
          return { ...prev, properties: { ...prev.properties, ...element } }
        })
      })
    }
  }
  const goBackToActivity = () => {
    navigate('/activity/' + id)
  }
  const editAgain = () => {
    setMessageSent(false)
    storeTeamInfo()
  }
  const goBackToRegisterDetail = () => {
    navigate('/activity/' + id + '/register-detail')
  }
  // // console.log(formSchema)
  return (
    <div>
      <TopBar activity="‚ÄúÊåëÊàòÊùØ‚ÄùÂàõÊñ∞Âàõ‰∏öÂ§ßËµõ" />
      <div className="activity-register-body">
        <div className="title">Êä•Âêç</div>
        <div className="activity-register-box">
          {messageSent === false ? (
            <Fragment>
              <FormRender
                form={form}
                schema={formSchema}
                onFinish={onFinish}
                onValuesChange={(values) => valueChangeAction(values)}
                style={{ maxWidth: '600px' }}
                disabled={loading}
              />
              <Button
                type="primary"
                onClick={form.submit}
                loading={loading}
                disabled={loading}
                style={{ marginTop: '2rem' }}
              >
                Êèê‰∫§
              </Button>
            </Fragment>
          ) : messageStatus === 'success' ? (
            <Result
              status="success"
              title="üòÑÔ∏è ‰ø°ÊÅØÊèê‰∫§ÊàêÂäü"
              subTitle="‰Ω†ÁöÑÊä•Âêç‰ø°ÊÅØÂ∑≤Êèê‰∫§ÔºåÁ•ù‰Ω†ÊØîËµõÈ°∫Âà©"
              extra={[
                <Button type="primary" key="back" onClick={goBackToActivity}>
                  ËøîÂõûÊØîËµõËØ¶ÊÉÖ
                </Button>,
                <Button key="re-edit" onClick={goBackToRegisterDetail}>
                  ËøîÂõûÊä•ÂêçËØ¶ÊÉÖ
                </Button>,
              ]}
            />
          ) : (
            <Result
              status="error"
              title="üò≠Ô∏è Êèê‰∫§Êó∂ÂèëÁîüÈîôËØØ"
              subTitle={'ÈîôËØØ‰ª£Á†ÅÔºö' + errCode + 'ÔºåÈîôËØØ‰ø°ÊÅØÔºö' + errMsg + 'ÔºåËØ∑ÂèäÊó∂ËÅîÁ≥ªÁÆ°ÁêÜÂëò'}
              extra={[
                <Button type="primary" onClick={goBackToActivity} key="back">
                  ËøîÂõûÊØîËµõËØ¶ÊÉÖ
                </Button>,
                <Button key="retry" onClick={editAgain}>
                  ÈáçÊñ∞Â∞ùËØïÊèê‰∫§
                </Button>,
              ]}
            />
          )}
        </div>
      </div>
    </div>
  )
}

export default Register
